---
title: "Module 03: Data manipulation with R"
output: html_document
---

So far we’ve learned how to make beauctiful graphs using `ggplot`. 
Now we are going to see how to manipulate, subset and modify data.frames using `dplyr` from the `tidyverse` package

We will learn:
How to select columns in a data.frame
How to filter a data.frame based on certain conditions
How to combine data manipulation and plotting
How to summarise data across groups


First let's load the `tydiverse` package
```{r}

#install.packages("visdat")
library(tidyverse)
#library(visdat)
#library(plotly)
```


Now let's upload the data file we want to work on, using `read_csv`
```{r}

x <- read_csv("../course_data/burghardt_et_al_2015_expt1.csv")
```


# Select certain columns in the data frame with the function `select`


```{r}

?select()
x.genot.temp <- select(x, genotype, temperature)

```


```{r}

x.bolt <- select(x,genotype, contains("bolt"))

```


# Select certain rows in the data frame according to filtering conditions with the function `filter`

```{r}

?filter()
x.vernalised <- filter(x, vernalization=="V")
  
```


In order to set the filtering conditions, several logical operators can be used:
`<` for less than and `<=` for less than or equal
`>` for less than and `>=` for more than or equal
`==` for equal
`!` for NOT (logical negation)

It is also possible to combine several conditions togeter using:
`&` for AND
`|` for OR

We can also identify NAs using:
`is.na()`


```{r}

x.vernalised.fluctuating <- filter(x, vernalization=="V" & fluctuation=="Var")

x.SD.or.late <- filter(x, day.length=="8" | days.to.bolt>85)
   
```


** Exercise **
Can you filter the data to keep the following?
Case 1: Samples that are not in the the Ler background and that have been treated with fluctuating temperature.
Case 2: Samples that are bolting at less than 57 days of flowing with less than 40 leaves
Case 3: Samples of genotypes fca-6 for which blade.ratio is not NA


```{r}
Enter your code here

```


# Modify data.frames using `mutate`
This is a useful function to add new variables (i.e. new columns) to the data.frame, or modify existing ones.


```{r}

?mutate()
x.cm <- mutate(x, blade.length.cm = blade.length.mm/10)
  
```

We can also modify/create more than one variable, separating them by `,`:

```{r}

x.cm <- mutate(x, blade.length.cm = blade.length.mm/10 , total.leaf.length.cm = total.leaf.length.mm/10)
  
```

Be careful! If we use the name of an existing variable, it will modify it instead. 


# Chain commands with `%>%` (pipes). 
It allows to perform a sequence of multiple operations, without a need for intermediate files (or very complicated nested command lines)

Now let’s say that we wanted to do several manipulations in our data.frame:

Create a new column containing total leaf length in cm
Filter our data so that it only contains vernalised plants
Retain only two columns from our table: genotype and total leaf length in cm
Based on what we’ve learned so far, we could for example do the following:

```{r}
x.filtered <- mutate(x, total.leaf.length.cm = total.leaf.length.mm/10)

x.filtered <- filter(x.filtered, vernalization=="V")

x.filtered <- select (x.filtered, genotype, total.leaf.length.cm )
```

dplyr allows to “chain” several commands using a special “pipe” function `%>%`. This is how the above code could have been written using this trick:

```{r}

x %>% 
  mutate(total.leaf.length.cm = total.leaf.length.mm/10) %>% 
  filter(vernalization=="V") %>% 
  select(genotype, total.leaf.length.cm)
```

** Exercise **
Use `%>%` to do the following on x:
- Keep samples that are not in the the Ler background and that have been treated with fluctuating temperature.
- Transform the blade length in cm
- Keep only the columns containing information about the genotype, blade length (in cm) and bolting information (hint, use `contains`)

```{r}
Enter your code here

```


# Combine all the above with graphs

We can pipe data manipulation with `ggplot` in order to produce graphs for a subset of the data

Let's say we want to make a boxplot of the flowering time in function if the temperature fluctuation (like in last session), however only for the vernalised samples
For this, we can use the following code: 

```{r}
x %>% 
  filter(vernalization=="V") %>% 
  ggplot(aes(fluctuation, days.to.flower)) + 
  geom_boxplot()

```


** Exercise**
Can you make a violin plot of the days to flower for the different genotypes that have been growing in short days? 


```{r}
Enter your code here

```


# Summarise data with `group_by` and `summarise`

Sometimes we might want to summarise our data in a smaller table. This kind of operation can be achieved by combining two `dplyr` functions together: `group_by` and `summarise`.

For example, we can summarise the mean flowering time for each genotype by typing:

```{r}
x %>% 
  group_by(genotype) %>% 
  summarise(mean.days.to.flower = mean(days.to.flower, na.rm=TRUE))

```


# Saving data to a file

Once we have modified our data we might want to save it to come back to it later. For this we can use the function `write_csv`

Let’s say that we were to remove all the missing data from our data to share it with a collaborator (or later use in R ourselves):

```{r}

x.blade.ratio.clean <- x %>% 
  filter(!is.na(blade.ratio))

write_csv(x.blade.ratio.clean, path = "data/x_blade_ratio_clean.csv")

```


# Some key points to remember
`dplyr` has several useful functions to manipulate data.frame objects
`dplyr` functions can be “chained” together using the `%>%` pipe
We can save data.frame to text-based files using the `write_*` family of functions


